name: Flutter Immune Build Pipeline

on:
  push:
    branches: [ main, develop, master ]
  pull_request:
    branches: [ main, develop, master ]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip test execution'
        required: false
        default: 'false'

env:
  FLUTTER_VERSION: '3.19.0'
  JAVA_VERSION: '17'
  PROJECT_NAME: 'cent'
  ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
  ANDROID_HOME: /usr/local/lib/android/sdk

jobs:
  immune-build:
    name: Immune Build & Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - build-type: release
            flutter-channel: stable
    
    steps:
      # ========================================================================
      # PHASE 1: ENVIRONMENT ISOLATION & SETUP
      # ========================================================================
      
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          clean: true
      
      - name: Setup Java 17 (OpenJDK)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
      
      - name: Verify Java Installation
        run: |
          echo "=== Java Environment Verification ==="
          java -version
          javac -version
          echo "JAVA_HOME: $JAVA_HOME"
          echo "========================================"
      
      - name: Setup Flutter 3.19.0
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'
          channel: 'stable'
          cache: true
          cache-key: 'flutter-3.19.0-stable'
          cache-path: ${{ runner.tool_cache }}/flutter
      
      - name: Verify Flutter Installation
        run: |
          echo "=== Flutter Environment Verification ==="
          flutter --version
          flutter doctor -v
          echo "=========================================="
      
      - name: Configure Android SDK Paths
        run: |
          echo "=== Android SDK Configuration ==="
          echo "ANDROID_HOME: $ANDROID_HOME"
          echo "ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
          
          # Ensure SDK directories exist
          sudo mkdir -p $ANDROID_SDK_ROOT || true
          sudo chmod -R 777 $ANDROID_SDK_ROOT || true
          
          # Accept all SDK licenses
          yes | flutter doctor --android-licenses || true
          
          echo "SDK configuration completed"
          echo "================================="
      
      # ========================================================================
      # PHASE 2: PRE-BUILD SURGERY (PROJECT SOVEREIGN)
      # ========================================================================
      
      - name: Setup Python 3.10+
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Verify Python Installation
        run: |
          echo "=== Python Environment ==="
          python --version
          python -c "import sys; print(f'Python {sys.version}')"
          echo "=========================="
      
      - name: Download Project Sovereign Script
        run: |
          echo "=== Acquiring Heuristic Compiler ==="
          
          # Check if script exists in repo
          if [ -f "project_sovereign.py" ]; then
            echo "âœ“ project_sovereign.py found in repository"
          else
            echo "âœ— project_sovereign.py not found"
            echo "Please ensure project_sovereign.py is committed to the repository"
            exit 1
          fi
          
          # Verify script integrity
          if python -m py_compile project_sovereign.py; then
            echo "âœ“ Script syntax validation passed"
          else
            echo "âœ— Script syntax validation failed"
            exit 1
          fi
          
          echo "===================================="
      
      - name: Execute Pre-Build Surgery
        id: sovereign
        run: |
          echo "=== INITIATING HEURISTIC COMPILER ==="
          echo "Target: $(pwd)"
          echo "Project: ${{ env.PROJECT_NAME }}"
          echo "======================================="
          
          # Execute Project Sovereign with error capture
          python project_sovereign.py "$(pwd)" 2>&1 | tee sovereign_log.txt
          
          SOVEREIGN_EXIT_CODE=${PIPESTATUS[0]}
          
          if [ $SOVEREIGN_EXIT_CODE -eq 0 ]; then
            echo "âœ“ Pre-build surgery completed successfully"
            echo "sovereign_status=success" >> $GITHUB_OUTPUT
          else
            echo "âš  Pre-build surgery encountered issues (exit code: $SOVEREIGN_EXIT_CODE)"
            echo "âš  Continuing with caution..."
            echo "sovereign_status=warning" >> $GITHUB_OUTPUT
          fi
          
          # Display surgery summary
          if [ -f "sovereign_log.txt" ]; then
            echo ""
            echo "=== SURGERY SUMMARY ==="
            tail -30 sovereign_log.txt
            echo "======================="
          fi
        continue-on-error: false
      
      - name: Upload Surgery Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sovereign-surgery-log
          path: sovereign_log.txt
          retention-days: 30
      
      # ========================================================================
      # PHASE 3: CLEAN SLATE PROTOCOL
      # ========================================================================
      
      - name: Nuclear Clean - Android Directory
        run: |
          echo "=== CLEAN SLATE PROTOCOL: Android ==="
          
          if [ -d "android" ]; then
            echo "Removing existing android/ directory..."
            rm -rf android/
            echo "âœ“ android/ directory removed"
          else
            echo "âœ“ android/ directory does not exist"
          fi
          
          echo "======================================"
        continue-on-error: false
      
      - name: Nuclear Clean - Lock Files
        run: |
          echo "=== CLEAN SLATE PROTOCOL: Lock Files ==="
          
          # Remove pubspec.lock
          if [ -f "pubspec.lock" ]; then
            echo "Removing pubspec.lock..."
            rm -f pubspec.lock
            echo "âœ“ pubspec.lock removed"
          else
            echo "âœ“ pubspec.lock does not exist"
          fi
          
          # Remove iOS lock files (if present)
          rm -f ios/Podfile.lock || true
          rm -rf ios/.symlinks || true
          rm -rf ios/Pods || true
          
          # Remove build artifacts
          rm -rf build/ || true
          rm -rf .dart_tool/ || true
          
          echo "âœ“ All lock files and build artifacts removed"
          echo "=========================================="
        continue-on-error: false
      
      - name: Re-Initialize Project Identity
        run: |
          echo "=== PROJECT RE-INITIALIZATION ==="
          echo "Project Name: ${{ env.PROJECT_NAME }}"
          
          # Backup pubspec.yaml
          cp pubspec.yaml pubspec.yaml.backup
          
          # Re-create project structure
          flutter create . --project-name ${{ env.PROJECT_NAME }} --org com.sovereign --platforms android,ios
          
          # Restore original pubspec.yaml (preserve dependencies)
          if [ -f "pubspec.yaml.backup" ]; then
            mv pubspec.yaml.backup pubspec.yaml
            echo "âœ“ Original pubspec.yaml restored"
          fi
          
          echo "âœ“ Project identity re-initialized"
          echo "=================================="
        continue-on-error: false
      
      - name: Reconstruct Android local.properties
        run: |
          echo "=== RECONSTRUCTING local.properties ==="
          
          # Ensure android directory exists
          mkdir -p android
          
          # Create local.properties with absolute SDK paths
          cat > android/local.properties << EOF
# Auto-generated by Immune Build Pipeline
# $(date -u +"%Y-%m-%d %H:%M:%S UTC")

sdk.dir=$ANDROID_SDK_ROOT
flutter.sdk=${{ env.FLUTTER_ROOT }}
flutter.buildMode=release
flutter.versionName=1.0.0
flutter.versionCode=1
EOF
          
          echo "âœ“ local.properties created:"
          cat android/local.properties
          
          # Verify SDK path exists
          if [ -d "$ANDROID_SDK_ROOT" ]; then
            echo "âœ“ Android SDK path verified: $ANDROID_SDK_ROOT"
          else
            echo "âš  Warning: Android SDK path does not exist"
            echo "âš  Attempting to create and configure..."
            sudo mkdir -p $ANDROID_SDK_ROOT || true
          fi
          
          echo "======================================="
        continue-on-error: false
      
      - name: Configure Gradle Properties
        run: |
          echo "=== GRADLE CONFIGURATION ==="
          
          mkdir -p android
          
          # Create gradle.properties with optimizations
          cat > android/gradle.properties << EOF
# Auto-generated Gradle configuration
# Immune Build Pipeline

org.gradle.jvmargs=-Xmx4096m -XX:MaxMetaspaceSize=1024m -XX:+HeapDumpOnOutOfMemoryError
org.gradle.parallel=true
org.gradle.caching=true
org.gradle.daemon=true
org.gradle.configureondemand=false

android.useAndroidX=true
android.enableJetifier=true
android.enableR8.fullMode=true
android.enableDexingArtifactTransform=false

kotlin.code.style=official
kotlin.incremental=true
kotlin.daemon.jvmargs=-Xmx2048m

flutter.minSdkVersion=21
flutter.targetSdkVersion=34
flutter.compileSdkVersion=34
EOF
          
          echo "âœ“ gradle.properties configured"
          echo "============================"
        continue-on-error: false
      
      # ========================================================================
      # PHASE 4: DEPENDENCY RESOLUTION
      # ========================================================================
      
      - name: Flutter Clean
        run: |
          echo "=== FLUTTER CLEAN ==="
          flutter clean
          echo "âœ“ Flutter clean completed"
          echo "====================="
        continue-on-error: true
      
      - name: Get Dependencies
        run: |
          echo "=== DEPENDENCY RESOLUTION ==="
          
          flutter pub get --verbose 2>&1 | tee pub_get_log.txt
          
          PUB_EXIT_CODE=${PIPESTATUS[0]}
          
          if [ $PUB_EXIT_CODE -eq 0 ]; then
            echo "âœ“ Dependencies resolved successfully"
          else
            echo "âš  Dependency resolution issues detected"
            echo "âš  Attempting recovery..."
            
            # Clear pub cache and retry
            flutter pub cache repair || true
            flutter pub get --verbose || true
          fi
          
          echo "=============================="
        continue-on-error: true
      
      - name: Upgrade Dependencies
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "=== DEPENDENCY UPGRADE (Manual Trigger) ==="
          flutter pub upgrade --verbose || true
          echo "============================================"
        continue-on-error: true
      
      - name: Verify Dependencies
        run: |
          echo "=== DEPENDENCY VERIFICATION ==="
          
          if [ -f "pubspec.lock" ]; then
            echo "âœ“ pubspec.lock generated"
            echo "Dependency count: $(grep -c "name:" pubspec.lock || echo "0")"
          else
            echo "âš  Warning: pubspec.lock not found"
          fi
          
          if [ -d ".dart_tool" ]; then
            echo "âœ“ .dart_tool directory exists"
          else
            echo "âš  Warning: .dart_tool directory missing"
          fi
          
          echo "================================"
        continue-on-error: true
      
      # ========================================================================
      # PHASE 5: PRE-COMPILE ANALYSIS
      # ========================================================================
      
      - name: Static Analysis
        run: |
          echo "=== STATIC ANALYSIS ==="
          flutter analyze --no-fatal-infos --no-fatal-warnings 2>&1 | tee analyze_log.txt || true
          echo "======================="
        continue-on-error: true
      
      - name: Format Check
        run: |
          echo "=== FORMAT CHECK ==="
          dart format --set-exit-if-changed . || true
          echo "===================="
        continue-on-error: true
      
      # ========================================================================
      # PHASE 6: IMMUNE BUILD EXECUTION
      # ========================================================================
      
      - name: Pre-Build Diagnostics
        run: |
          echo "=== PRE-BUILD DIAGNOSTICS ==="
          echo "Flutter Version: $(flutter --version | head -n 1)"
          echo "Dart Version: $(dart --version)"
          echo "Java Version: $(java -version 2>&1 | head -n 1)"
          echo "Working Directory: $(pwd)"
          echo "Available Disk Space: $(df -h . | tail -n 1 | awk '{print $4}')"
          echo "Available Memory: $(free -h | grep Mem | awk '{print $7}')"
          echo "============================="
      
      - name: Build APK (Release) - Immune Mode
        id: build_apk
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘     IMMUNE BUILD EXECUTION - RELEASE MODE          â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # Set build start time
          BUILD_START=$(date +%s)
          
          # Execute immune build with all safety flags
          flutter build apk \
            --release \
            --no-tree-shake-icons \
            --extra-front-end-options=--no-sound-null-safety \
            --extra-gen-snapshot-options=--no-sound-null-safety \
            --verbose \
            2>&1 | tee build_log.txt
          
          BUILD_EXIT_CODE=${PIPESTATUS[0]}
          BUILD_END=$(date +%s)
          BUILD_DURATION=$((BUILD_END - BUILD_START))
          
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘              BUILD RESULT SUMMARY                  â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          
          if [ $BUILD_EXIT_CODE -eq 0 ]; then
            echo "â•‘ Status: âœ“ SUCCESS                                  â•‘"
            echo "â•‘ Duration: ${BUILD_DURATION}s                                    â•‘"
            echo "build_status=success" >> $GITHUB_OUTPUT
            
            # Verify APK exists
            if [ -f "build/app/outputs/flutter-apk/app-release.apk" ]; then
              APK_SIZE=$(du -h build/app/outputs/flutter-apk/app-release.apk | cut -f1)
              echo "â•‘ APK Size: $APK_SIZE                                  â•‘"
              echo "apk_size=$APK_SIZE" >> $GITHUB_OUTPUT
            fi
          else
            echo "â•‘ Status: âœ— FAILED                                   â•‘"
            echo "â•‘ Exit Code: $BUILD_EXIT_CODE                              â•‘"
            echo "â•‘ Duration: ${BUILD_DURATION}s                                    â•‘"
            echo "build_status=failed" >> $GITHUB_OUTPUT
          fi
          
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # Strict failure on build errors
          exit $BUILD_EXIT_CODE
        continue-on-error: false
      
      - name: Verify Build Artifacts
        if: steps.build_apk.outputs.build_status == 'success'
        run: |
          echo "=== BUILD ARTIFACT VERIFICATION ==="
          
          APK_PATH="build/app/outputs/flutter-apk/app-release.apk"
          
          if [ -f "$APK_PATH" ]; then
            echo "âœ“ APK found: $APK_PATH"
            echo "âœ“ Size: $(du -h $APK_PATH | cut -f1)"
            echo "âœ“ Checksum: $(sha256sum $APK_PATH | cut -d' ' -f1)"
            
            # Test APK validity with aapt (if available)
            if command -v aapt &> /dev/null; then
              echo ""
              echo "APK Metadata:"
              aapt dump badging $APK_PATH | head -n 5 || true
            fi
          else
            echo "âœ— APK not found at expected location"
            exit 1
          fi
          
          echo "==================================="
      
      # ========================================================================
      # PHASE 7: ALTERNATIVE BUILD TARGETS (OPTIONAL)
      # ========================================================================
      
      - name: Build APK Split (Per-ABI)
        if: steps.build_apk.outputs.build_status == 'success' && github.event_name == 'workflow_dispatch'
        run: |
          echo "=== BUILDING SPLIT APKS ==="
          
          flutter build apk \
            --release \
            --split-per-abi \
            --no-tree-shake-icons \
            --extra-front-end-options=--no-sound-null-safety \
            --extra-gen-snapshot-options=--no-sound-null-safety \
            --verbose || true
          
          # List all generated APKs
          echo ""
          echo "Generated APKs:"
          find build/app/outputs/flutter-apk/ -name "*.apk" -exec ls -lh {} \;
          
          echo "==========================="
        continue-on-error: true
      
      - name: Build App Bundle (AAB)
        if: steps.build_apk.outputs.build_status == 'success' && github.event_name != 'pull_request'
        run: |
          echo "=== BUILDING APP BUNDLE ==="
          
          flutter build appbundle \
            --release \
            --no-tree-shake-icons \
            --extra-front-end-options=--no-sound-null-safety \
            --extra-gen-snapshot-options=--no-sound-null-safety \
            --verbose || true
          
          if [ -f "build/app/outputs/bundle/release/app-release.aab" ]; then
            echo "âœ“ AAB generated successfully"
            echo "âœ“ Size: $(du -h build/app/outputs/bundle/release/app-release.aab | cut -f1)"
          fi
          
          echo "==========================="
        continue-on-error: true
      
      # ========================================================================
      # PHASE 8: TESTING (CONDITIONAL)
      # ========================================================================
      
      - name: Run Unit Tests
        if: github.event.inputs.skip_tests != 'true'
        run: |
          echo "=== UNIT TESTS ==="
          flutter test --coverage --verbose 2>&1 | tee test_log.txt || true
          echo "=================="
        continue-on-error: true
      
      - name: Upload Test Results
        if: always() && github.event.inputs.skip_tests != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            test_log.txt
            coverage/
          retention-days: 30
        continue-on-error: true
      
      # ========================================================================
      # PHASE 9: ARTIFACT COLLECTION & UPLOAD
      # ========================================================================
      
      - name: Collect Build Logs
        if: always()
        run: |
          echo "=== COLLECTING BUILD ARTIFACTS ==="
          
          mkdir -p pipeline_artifacts
          
          # Copy logs
          cp sovereign_log.txt pipeline_artifacts/ 2>/dev/null || true
          cp pub_get_log.txt pipeline_artifacts/ 2>/dev/null || true
          cp analyze_log.txt pipeline_artifacts/ 2>/dev/null || true
          cp build_log.txt pipeline_artifacts/ 2>/dev/null || true
          cp test_log.txt pipeline_artifacts/ 2>/dev/null || true
          
          # Create pipeline summary
          cat > pipeline_artifacts/pipeline_summary.txt << EOF
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘         IMMUNE BUILD PIPELINE - EXECUTION SUMMARY          â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ Workflow: ${{ github.workflow }}
â•‘ Run ID: ${{ github.run_id }}
â•‘ Run Number: ${{ github.run_number }}
â•‘ Trigger: ${{ github.event_name }}
â•‘ Branch: ${{ github.ref_name }}
â•‘ Commit: ${{ github.sha }}
â•‘ Actor: ${{ github.actor }}
â•‘ Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
â•‘
â•‘ Environment:
â•‘   - Flutter: ${{ env.FLUTTER_VERSION }}
â•‘   - Java: ${{ env.JAVA_VERSION }}
â•‘   - Project: ${{ env.PROJECT_NAME }}
â•‘   - Runner: ${{ runner.os }} (${{ runner.arch }})
â•‘
â•‘ Surgery Status: ${{ steps.sovereign.outputs.sovereign_status }}
â•‘ Build Status: ${{ steps.build_apk.outputs.build_status }}
â•‘ APK Size: ${{ steps.build_apk.outputs.apk_size }}
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF
          
          cat pipeline_artifacts/pipeline_summary.txt
          
          echo "âœ“ Artifacts collected"
          echo "==================================="
      
      - name: Upload Build Artifacts (APK)
        if: steps.build_apk.outputs.build_status == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: android-release-apk
          path: |
            build/app/outputs/flutter-apk/*.apk
            build/app/outputs/bundle/release/*.aab
          retention-days: 90
          if-no-files-found: warn
      
      - name: Upload Pipeline Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pipeline-logs
          path: pipeline_artifacts/
          retention-days: 30
      
      - name: Upload Flutter Doctor Output
        if: failure()
        run: |
          flutter doctor -v > flutter_doctor_failure.txt 2>&1 || true
        continue-on-error: true
      
      - name: Upload Failure Diagnostics
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failure-diagnostics
          path: |
            flutter_doctor_failure.txt
            build_log.txt
            android/
          retention-days: 30
        continue-on-error: true
      
      # ========================================================================
      # PHASE 10: NOTIFICATION & REPORTING
      # ========================================================================
      
      - name: Build Status Summary
        if: always()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘              PIPELINE EXECUTION COMPLETE                   â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          
          if [ "${{ steps.build_apk.outputs.build_status }}" == "success" ]; then
            echo "â•‘ âœ“ Build: SUCCESSFUL                                        â•‘"
            echo "â•‘ âœ“ Artifacts: Ready for deployment                         â•‘"
            echo "â•‘                                                            â•‘"
            echo "â•‘ Next Steps:                                                â•‘"
            echo "â•‘   1. Download APK from workflow artifacts                 â•‘"
            echo "â•‘   2. Test on physical devices                             â•‘"
            echo "â•‘   3. Deploy to Google Play Console                        â•‘"
          else
            echo "â•‘ âœ— Build: FAILED                                            â•‘"
            echo "â•‘ âœ— Review logs for error details                           â•‘"
            echo "â•‘                                                            â•‘"
            echo "â•‘ Troubleshooting:                                           â•‘"
            echo "â•‘   1. Check build_log.txt in artifacts                     â•‘"
            echo "â•‘   2. Review sovereign_log.txt for surgery issues          â•‘"
            echo "â•‘   3. Verify pubspec.yaml dependencies                     â•‘"
          fi
          
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      - name: Job Summary
        if: always()
        run: |
          echo "### ðŸš€ Immune Build Pipeline - Execution Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Environment Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Flutter:** ${{ env.FLUTTER_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Java:** ${{ env.JAVA_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Project:** ${{ env.PROJECT_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Runner:** ${{ runner.os }} (${{ runner.arch }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Execution Results" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.build_apk.outputs.build_status }}" == "success" ]; then
            echo "- âœ… **Build Status:** SUCCESS" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ“¦ **APK Size:** ${{ steps.build_apk.outputs.apk_size }}" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ”§ **Surgery:** ${{ steps.sovereign.outputs.sovereign_status }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ **Build Status:** FAILED" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ”§ **Surgery:** ${{ steps.sovereign.outputs.sovereign_status }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please review the pipeline logs for detailed error information." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Generated by Immune Build Pipeline*" >> $GITHUB_STEP_SUMMARY
