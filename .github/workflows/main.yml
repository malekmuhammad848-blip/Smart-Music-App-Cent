name: Build Cent APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Ù„Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Ø¬Ù„Ø¨ Ø§Ù„ÙƒÙˆØ¯
    - name: Checkout repository
      uses: actions/checkout@v4
      
    # 2. Ø¥Ø¹Ø¯Ø§Ø¯ Java (Ù…Ø·Ù„ÙˆØ¨ Ù„Ù€ Android)
    - name: Setup Java JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    # 3. Ø¥Ø¹Ø¯Ø§Ø¯ Flutter
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.19.0'
        channel: 'stable'
        cache: true
        cache-key: flutter-cache
        
    # 4. Ø¹Ø±Ø¶ Ø¥ØµØ¯Ø§Ø± Flutter Ù„Ù„ØªØ£ÙƒØ¯
    - name: Verify Flutter installation
      run: flutter --version
      
    # 5. Ø¥Ù†Ø´Ø§Ø¡ local.properties Ù„Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©
    - name: Create local.properties for CI
      run: |
        echo "sdk.dir=$ANDROID_HOME" > android/local.properties
        echo "flutter.sdk=$FLUTTER_ROOT" >> android/local.properties
        echo "flutter.versionName=1.0.0" >> android/local.properties
        echo "flutter.versionCode=1" >> android/local.properties
        echo "flutter.buildMode=release" >> android/local.properties
        
    # 6. Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© settings.gradle - Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø¨Ø³ÙŠØ·Ø©
    - name: Fix settings.gradle
      run: |
        # Ù†Ø³Ø®Ø© Ù…Ø¨Ø³Ø·Ø© Ù…Ù† settings.gradle
        cat > android/settings.gradle << 'EOF'
        include ':app'

        def localPropertiesFile = new File(rootProject.projectDir, "local.properties")
        def properties = new Properties()

        if (localPropertiesFile.exists()) {
            localPropertiesFile.withReader("UTF-8") { reader ->
                properties.load(reader)
            }
        }

        def flutterSdkPath = properties.getProperty("flutter.sdk")
        if (flutterSdkPath == null) {
            throw new GradleException("flutter.sdk not set in local.properties")
        }

        apply from: "$flutterSdkPath/packages/flutter_tools/gradle/app_plugin_loader.gradle"
        EOF
        
        # Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù„Ù„ØªØ£ÙƒØ¯
        echo "âœ… Created settings.gradle:"
        cat android/settings.gradle
        
    # 7. ØªØ«Ø¨ÙŠØª Ø§Ù„Ø­Ø²Ù… ÙˆØ§Ù„ØªØ¨Ø¹ÙŠØ§Øª
    - name: Get Flutter dependencies
      run: |
        flutter pub get
        flutter clean
        
    # 8. ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
    - name: Analyze code
      run: flutter analyze
      continue-on-error: true  # Ù„Ø§ ÙŠÙˆÙ‚Ù Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ ØªØ­Ø°ÙŠØ±Ø§Øª
        
    # 9. Ø¨Ù†Ø§Ø¡ APK Ù…Ø¹ Ø®ÙŠØ§Ø±Ø§Øª Ø®Ø§ØµØ© Ù„Ù„Ø§Ø³ØªÙ‚Ø±Ø§Ø±
    - name: Build APK (Release)
      run: |
        flutter build apk --release \
          --no-tree-shake-icons \
          --split-per-abi
        
    # 10. Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù†Ø§ØªØ¬Ø©
    - name: Upload APK artifacts
      uses: actions/upload-artifact@v4
      with:
        name: cent-music-apk
        path: |
          build/app/outputs/flutter-apk/app-release.apk
          build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk
          build/app/outputs/flutter-apk/app-arm64-v8a-release.apk
        retention-days: 7
        
    # 11. Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ­Ù…ÙŠÙ„
    - name: Show download info
      run: |
        echo "ğŸµ ==========================================="
        echo "âœ… BUILD SUCCESSFUL!"
        echo "ğŸ“± APK files are available in the Artifacts tab"
        echo "ğŸ“¦ Files generated:"
        echo "   - app-release.apk (universal)"
        echo "   - app-armeabi-v7a-release.apk (32-bit)"
        echo "   - app-arm64-v8a-release.apk (64-bit)"
        echo "ğŸµ ==========================================="
