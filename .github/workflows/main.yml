name: Build Cent APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Ù„Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Ø¬Ù„Ø¨ Ø§Ù„ÙƒÙˆØ¯
    - name: Checkout repository
      uses: actions/checkout@v4
      
    # 2. Ø¥Ø¹Ø¯Ø§Ø¯ Java
    - name: Setup Java JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    # 3. Ø¥Ø¹Ø¯Ø§Ø¯ Flutter
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.19.0'
        channel: 'stable'
        
    # 4. Ø¥ØµÙ„Ø§Ø­ AndroidManifest.xml
    - name: Fix AndroidManifest.xml
      run: |
        # ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ù„Ù
        if [ -f "android/app/src/main/AndroidManifest.xml" ]; then
          # Ø­Ø°Ù package Ù…Ù† AndroidManifest.xml
          sed -i '/package="[^"]*"/d' android/app/src/main/AndroidManifest.xml
          
          # Ø­Ø°Ù Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…Ø®ØµØµØ© (Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©)
          sed -i '/android:icon="@mipmap\/ic_launcher"/d' android/app/src/main/AndroidManifest.xml
          
          # ØªØ£ÙƒÙŠØ¯ Ø§Ø³Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
          if ! grep -q 'android:label="Cent Music"' android/app/src/main/AndroidManifest.xml; then
            sed -i 's/android:label="[^"]*"/android:label="Cent Music"/g' android/app/src/main/AndroidManifest.xml
          fi
          
          echo "âœ… AndroidManifest.xml fixed"
        else
          echo "âš ï¸ AndroidManifest.xml not found, creating new one"
          mkdir -p android/app/src/main
          cat > android/app/src/main/AndroidManifest.xml << 'EOF'
<manifest xmlns:android="http://schemas.android.com/apk/res/android">
    <uses-permission android:name="android.permission.INTERNET"/>
    <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE"/>
    <uses-permission android:name="android.permission.WAKE_LOCK"/>
    
    <application
        android:label="Cent Music"
        android:name="\${applicationName}"
        android:allowBackup="true"
        android:supportsRtl="true">
        
        <activity
            android:name=".MainActivity"
            android:exported="true"
            android:launchMode="singleTop"
            android:theme="@style/LaunchTheme"
            android:configChanges="orientation|keyboardHidden|keyboard|screenSize|smallestScreenSize|locale|layoutDirection|fontScale|screenLayout|density|uiMode"
            android:hardwareAccelerated="true"
            android:windowSoftInputMode="adjustResize">
            
            <meta-data
                android:name="io.flutter.embedding.android.NormalTheme"
                android:resource="@style/NormalTheme"/>
            
            <intent-filter>
                <action android:name="android.intent.action.MAIN"/>
                <category android:name="android.intent.category.LAUNCHER"/>
            </intent-filter>
        </activity>
        
        <meta-data
            android:name="flutterEmbedding"
            android:value="2"/>
    </application>
</manifest>
EOF
        fi
        
    # 5. Ø¥ØµÙ„Ø§Ø­ build.gradle
    - name: Fix build.gradle
      run: |
        # ØªØ­Ø¯ÙŠØ« namespace Ùˆ applicationId
        if [ -f "android/app/build.gradle" ]; then
          sed -i 's/namespace "com\.example\.[^"]*"/namespace "com.cent.music"/g' android/app/build.gradle
          sed -i 's/applicationId "com\.example\.[^"]*"/applicationId "com.cent.music"/g' android/app/build.gradle
          
          # ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ minSdkVersion 21
          if ! grep -q 'minSdkVersion 21' android/app/build.gradle; then
            sed -i 's/minSdkVersion [0-9]*/minSdkVersion 21/g' android/app/build.gradle
          fi
          
          echo "âœ… build.gradle fixed"
        fi
        
        # Ø¥Ø¶Ø§ÙØ© jcenter Ø¥Ù„Ù‰ android/build.gradle
        if [ -f "android/build.gradle" ]; then
          if ! grep -q 'jcenter()' android/build.gradle; then
            sed -i '/repositories {/a\        jcenter()' android/build.gradle
            sed -i '/allprojects {/,/}/ {
              /repositories {/a\        jcenter()
            }' android/build.gradle
          fi
        fi
        
    # 6. Ø¥ØµÙ„Ø§Ø­ audio_kernel.dart (Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹)
    - name: Fix audio_kernel.dart
      run: |
        if [ -f "lib/core/audio_kernel.dart" ]; then
          # Ø¥ØµÙ„Ø§Ø­ event.state Ø¥Ù„Ù‰ event.processingState
          sed -i 's/event\.state == ja\.ProcessingState\.idle/event.processingState == ja.ProcessingState.idle/g' lib/core/audio_kernel.dart
          
          # Ø¥ØµÙ„Ø§Ø­ ListQueue Ø¥Ù„Ù‰ List
          sed -i 's/final _playlist = ListQueue<AudioTrack>();/final List<AudioTrack> _playlist = [];/g' lib/core/audio_kernel.dart
          sed -i 's/final _originalPlaylist = ListQueue<AudioTrack>();/final List<AudioTrack> _originalPlaylist = [];/g' lib/core/audio_kernel.dart
          
          # Ø­Ø°Ù Ù‚Ø³Ù… export ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ© (Ø¥Ù† ÙˆØ¬Ø¯)
          sed -i '/^\/\/ ============================================/,/^FFTProcessor;/d' lib/core/audio_kernel.dart
          
          echo "âœ… audio_kernel.dart fixed"
        fi
        
    # 7. Ø¥Ù†Ø´Ø§Ø¡ local.properties
    - name: Create local.properties
      run: |
        echo "sdk.dir=$ANDROID_HOME" > android/local.properties
        echo "flutter.sdk=$FLUTTER_ROOT" >> android/local.properties
        echo "flutter.versionName=1.0.0" >> android/local.properties
        echo "flutter.versionCode=1" >> android/local.properties
        echo "flutter.buildMode=release" >> android/local.properties
        
    # 8. ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª
    - name: Get Flutter dependencies
      run: |
        flutter clean
        flutter pub get
        flutter pub upgrade --major-versions
        
    # 9. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Flutter
    - name: Verify Flutter
      run: |
        flutter doctor -v
        flutter analyze
        
    # 10. Ø¨Ù†Ø§Ø¡ APK
    - name: Build APK (Release)
      run: |
        flutter build apk --release \
          --no-tree-shake-icons \
          --split-per-abi
          
    # 11. Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù†Ø§ØªØ¬Ø©
    - name: Upload APK artifacts
      uses: actions/upload-artifact@v4
      with:
        name: cent-music-apk
        path: |
          build/app/outputs/flutter-apk/app-release.apk
          build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk
          build/app/outputs/flutter-apk/app-arm64-v8a-release.apk
        retention-days: 30
        
    # 12. Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ­Ù…ÙŠÙ„
    - name: Show download info
      if: success()
      run: |
        echo "ğŸµ ==========================================="
        echo "âœ… BUILD SUCCESSFUL!"
        echo "ğŸ“± APK files are available in the Artifacts tab"
        echo "ğŸ“¦ Files generated:"
        echo "   - app-release.apk (universal)"
        echo "   - app-armeabi-v7a-release.apk (32-bit)"
        echo "   - app-arm64-v8a-release.apk (64-bit)"
        echo "ğŸµ ==========================================="
        
    # 13. ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„
    - name: Upload logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          flutter.log
          build.log
        retention-days: 1
